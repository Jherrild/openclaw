# PRD: Copilot Delegate v2 (Async & Observable)

## 1. Goal
Transform `copilot-delegate` from a synchronous, blocking call into a robust, observable **Job Queue**. Enable "fire-and-forget" coding tasks with reliable notifications and a persistent audit trail.

## 2. Problem Statement
*   **Blocking:** The agent (and user) must wait for `copilot-delegate` to finish before doing anything else.
*   **Fragile:** If the session crashes or the agent is restarted during a run, the task is lost.
*   **Opaque:** It's hard to see *what* prompt was sent to Copilot, *which* model was used, and *why* it succeeded or failed without digging into raw logs.
*   **Concurrency:** Multiple requests clash with the single lock file.

## 3. Core Features

### 3.1. The Job Queue (Async Execution)
*   **Mechanism:** A persistent queue (JSON/SQLite) of pending tasks.
*   **Worker:** A background daemon (Node.js/Python) that:
    1.  Polls the queue.
    2.  Acquires the `copilot-lock`.
    3.  Executes the task via `gh copilot`.
    4.  Updates the job status (running -> success/failed).
    5.  Releases the lock.
*   **Concurrency:** Enforces serial execution (one at a time) to prevent race conditions on the codebase, but allows *queueing* multiple tasks.

### 3.2. Integration with Interrupt Service
*   **Trigger:** When a job completes (success or failure), the worker fires an event to `interrupt-service`.
*   **Notification:** The Main Agent receives a structured alert: "Job #123 (Fix Typo) Complete. Status: Success."

### 3.3. Observability Log (The Audit Trail)
*   **Artifact:** A structured log file (Markdown/JSONL) at `.openclaw/copilot-audit.md` or `.jsonl`.
*   **Content:**
    *   **Timestamp:** When the job started/finished.
    *   **Job ID:** Unique identifier.
    *   **Prompt:** The exact instruction sent to Copilot.
    *   **Model:** The model used (e.g., `claude-3.5-sonnet`).
    *   **Outcome:** Success/Failure + Exit Code.
    *   **Summary:** The "Summary of Changes" generated by Copilot.
    *   **Diff Stat:** Files changed lines added/removed.

## 4. Technical Architecture
*   **Queue:** `skills/copilot-delegate/queue.json`
*   **Worker:** `skills/copilot-delegate/worker.js` (managed by `task-orchestrator`)
*   **Commands:**
    *   `delegate_async(prompt, model)` -> Returns `jobId`.
    *   `delegate_status(jobId)` -> Returns current state.
    *   `delegate_log()` -> Reads the audit trail.

## 5. Success Criteria
*   **Non-Blocking:** Agent can queue 3 tasks and continue chatting immediately.
*   **Reliability:** Zero lost tasks if the session restarts.
*   **Visibility:** User can run `cat .openclaw/copilot-audit.md` to see exactly what the AI did to the code.
