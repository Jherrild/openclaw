---
name: home-presence
description: Give Magnus a physical presence in the home — detect occupied rooms, check person home/away status, and speak through local smart speakers using Google AI TTS with the Alnilam voice.
---

# Home Presence

Detect who is home, which rooms are occupied, and route speech to those rooms via Home Assistant TTS.

## Configuration

- **Script Path:** `/home/jherrild/.openclaw/workspace/skills/home-presence/presence.js`
- **HA Token:** Extracted automatically from `config/mcporter.json` (`ha-stdio-final` entry).
- **TTS Engine:** `tts.google_ai_tts` (Google AI TTS)
- **Voice:** `alnilam` (Alnilam — Firm)
- **Default Fallback Area:** Living Room
- **Layout File:** `layout.json` (auto-generated by `update-layout`, optional)

### Person Entities

| Entity | Description |
|--------|-------------|
| `person.jesten` | Primary resident |
| `person.april_jane` | Secondary resident |

### Known Areas → Speakers

| Area | Speaker Entity |
|------|---------------|
| Living Room | `media_player.living_room_speaker` |
| Basement | `media_player.basement` |
| Gym | `media_player.gym` |
| Office | `media_player.pink_window` |
| Bedroom | `media_player.upstairs_bedroom` |
| Kitchen | `media_player.living_room_speaker` (fallback) |
| Dining | `media_player.living_room_speaker` (fallback) |
| Home Group | `media_player.home_group` (all speakers) |

> These are hardcoded defaults. Run `update-layout` to auto-discover mappings from Home Assistant's area/device registry.

### Presence Sensors

| Area | Sensor | Type |
|------|--------|------|
| Kitchen | `binary_sensor.everything_presence_lite_5c0db4_occupancy` | mmWave Occupancy |
| Office | `binary_sensor.everything_presence_lite_4f1008_occupancy` | mmWave Occupancy |
| Gym | `binary_sensor.everything_presence_lite_5c0d08_occupancy` | mmWave Occupancy |
| Bedroom | `binary_sensor.everything_presence_lite_5c0da4_occupancy` | mmWave Occupancy |
| Basement | `binary_sensor.everything_presence_lite_ab20a4_occupancy` | mmWave Occupancy |
| Front Yard | `binary_sensor.front_door_motion` | PIR Motion |
| Kitchen | `sensor.everything_presence_lite_5c0db4_co2` | CO₂ fallback (>600 ppm) |
| Office | `sensor.everything_presence_lite_4f1008_co2` | CO₂ fallback (>600 ppm) |
| Gym | `sensor.everything_presence_lite_5c0d08_co2` | CO₂ fallback (>600 ppm) |

## Tools

### locate_presence

Detect which areas are currently occupied and whether anyone is home.

**Occupancy Logic (in order):**
1. Check `person.jesten` and `person.april_jane` for home/away status.
2. Check mmWave occupancy sensors.
3. Check PIR motion sensors.
4. Check CO₂ levels (>600 ppm).
5. If ALL persons are away AND no sensor presence → `houseEmpty: true`.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js locate
```

**Output:** JSON with `houseEmpty`, `personsHome`, `occupied` (list of area names), `details` (sensor data), `fallback` (set to "Living Room" if persons are home but no room detected; `null` if house is empty), and `layoutSource`.

### announce_to_room

Speak a message through the speaker(s) in a specific area.

**Parameters:**
- `area`: Area name (e.g., "Living Room", "Office", "Gym").
- `message`: The text to speak.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js announce "Office" "Your coffee is ready."
```

### follow_and_speak

Detect who is home and speak in all occupied rooms. If the house is empty (all persons away + no sensor presence), skips TTS entirely.

**Priority Routing:** When the `--priority` flag is passed, the message is treated as important/high-priority and is routed to the **Home Group** (`media_player.home_group`), which targets all speakers simultaneously — bypassing per-room presence detection.

**Routing Rules:**
1. `--priority` flag → Home Group (all speakers)
2. House empty (all away + no sensors) → Skip TTS, return note
3. Presence detected → occupied room speakers only
4. No room-level presence but someone is home → Living Room speaker (default fallback)

**Parameters:**
- `message`: The text to speak.
- `--priority` *(optional)*: Route to all speakers via Home Group.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak "Good morning."
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak --priority "Emergency: water leak detected!"
```

**Output:** JSON showing which areas were occupied, which speakers were targeted, and the result of each TTS call.

### update_layout

Query Home Assistant's area and device registries to auto-discover area→speaker, area→sensor mappings. Writes `layout.json` next to `presence.js`. Run this when new hardware is added.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js update-layout
```

**Output:** JSON with discovered areas, speakers, occupancy sensors, motion sensors, and CO₂ sensors. Also writes `layout.json` for subsequent runs.

## HA WebSocket Bridge (`ha-bridge.js`)

A persistent WebSocket connection to Home Assistant that subscribes to **all** `state_changed` events and routes them to **multiple rolling JSONL logs** based on dynamic domain/pattern matching.

### Architecture: Multi-Tiered Passive Logging

The bridge operates in **passive log-only mode** by default. Instead of filtering to a hard-coded entity list, it classifies every state change event by entity domain and naming patterns, routing each to the appropriate tier-specific log file. All logs are capped at **5,000 lines** (trimmed to 4,000 on overflow).

**Log Tiers (evaluated in order — first match wins):**

| Tier | File | Matches |
|------|------|---------|
| `presence` | `presence-log.jsonl` | `person.*`, `binary_sensor.*occupancy`, `binary_sensor.*motion`, `binary_sensor.*presence` |
| `lighting` | `lighting-log.jsonl` | `light.*` |
| `climate` | `climate-log.jsonl` | `climate.*`, `sensor.*temperature`, `sensor.*humidity`, `sensor.*co2`, `switch.*heater`, `switch.*fan` |
| `automation` | `automation-log.jsonl` | `automation.*`, `script.*` |
| `raw` | `home-status-raw.jsonl` | Everything else (catch-all), excluding noisy entities (`sun.*`, `sensor.*uptime`, `sensor.*last_boot`) |

New devices added to Home Assistant that match these patterns are logged **automatically** — no code changes needed.

**High-priority wake support** is plumbed in via the `WAKE_ON_ENTITIES` set in `ha-bridge.js`. This set is currently **empty**. To re-enable agent-waking for specific entities, add their IDs to the set:

```js
const WAKE_ON_ENTITIES = new Set([
  'person.jesten',                      // wake when Jesten arrives/leaves
  'binary_sensor.front_door_motion',    // wake on front door motion
]);
```

Only entities in `WAKE_ON_ENTITIES` will trigger `openclaw system event`; all others are logged silently.

### Intelligent Interrupt Dispatcher

The bridge includes an **Intelligent Interrupt Dispatcher** (`interrupt-manager.js`) that lets Magnus (or the user) register conditional alerts — either **persistent** (fire every time) or **one-off** (fire once, then auto-remove).

#### Dual-Pipeline Architecture

Interrupts are classified into two **independent pipelines** based on their `type` field:

| Pipeline | Type | Behavior | Default Batch Window | Default Rate Limit |
|----------|------|----------|---------------------|-------------------|
| **Message** | `message` | Direct delivery via `openclaw sessions send` — no AI evaluation | 2s | 10/min |
| **Subagent** | `subagent` | Spawns a Gemini Flash sub-agent to evaluate context before notifying | 5s | 4/min |

Each pipeline has its own:
- **Batch queue** — triggers are collected within the pipeline's batch window
- **Rate limiter** — independent rolling-window rate limit
- **Circuit breaker** — opens when rate limit is exceeded, recovers automatically

Pipelines never cross: message and subagent interrupts are batched, rate-limited, and dispatched completely independently.

#### Pipeline Settings (`interrupt-settings.json`)

All pipeline constants are stored in `interrupt-settings.json` and can be updated at runtime (the manager hot-reloads the file):

```json
{
  "message": {
    "batch_window_ms": 2000,
    "rate_limit_max": 10,
    "rate_limit_window_ms": 60000
  },
  "subagent": {
    "batch_window_ms": 5000,
    "rate_limit_max": 4,
    "rate_limit_window_ms": 60000
  },
  "file_poll_ms": 2000,
  "log_limit": 1000
}
```

Manage settings via the CLI:

```bash
# View current settings
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js get-settings

# Update a setting (JSON merge patch)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js set-settings '{"message":{"batch_window_ms":1000}}'
```

#### Interrupt Files

| File | Purpose |
|------|---------|
| `persistent-interrupts.json` | Rules that fire every time a match occurs |
| `one-off-interrupts.json` | Rules that fire once and are automatically removed |

#### Interrupt Rule Schema

```json
{
  "id": "int-abc123",
  "entity_id": "binary_sensor.front_door_motion",
  "state": "on",
  "label": "Front door motion",
  "message": "Motion detected at front door",
  "instruction": "Check if anyone is expected; if not, announce security alert via follow-and-speak",
  "channel": "default",
  "created": "2026-02-08T22:00:00.000Z"
}
```

| Field | Required | Description |
|-------|----------|-------------|
| `id` | Yes | Unique identifier (auto-generated by `register-interrupt.js`) |
| `entity_id` | Yes | HA entity ID — exact match or wildcard (e.g., `light.*`) |
| `state` | No | If set, only fires when `new_state` matches this value. If `null`, fires on any state change. |
| `label` | No | Human-readable name for logging |
| `message` | No | Custom text for the `openclaw system event`. If omitted, a default is generated. |
| `instruction` | No | Custom instructions/context appended to the system event text when the interrupt fires. Use this to tell the agent HOW to react (e.g., "announce via TTS", "log and summarize"). |
| `channel` | No | Notification channel for dispatch (e.g., `telegram`). If `"default"` or omitted, resolves to `config.json`'s `default_channel` at dispatch time. |
| `created` | No | ISO timestamp of rule creation |

#### Batching, Rate Limiting, and Circuit Breaker

Each pipeline (`message` and `subagent`) independently:

- **Batching:** Matched triggers are collected in the pipeline's batch window (configurable in `interrupt-settings.json`). All triggers within that window are combined into a single dispatch.
- **Message Dispatch:** Messages are sent directly via `openclaw sessions send --session <id> --text "..."` — no sub-agent overhead.
- **Subagent Dispatch:** A **sub-agent** (Gemini Flash) is spawned to analyze the interrupt. It checks context (logs, state) and only sends a message to the main session if necessary.
- **Rate Limiting:** Each pipeline has its own max dispatches per window (e.g., message: 10/min, subagent: 4/min).
- **Circuit Breaker:** If a pipeline's rate limit is exceeded, that pipeline stops firing and logs a warning. It automatically recovers when the rate drops below the limit. The other pipeline is unaffected.

All interrupt activity (queued, batched, dispatched, rate-limited) is logged to `ha-bridge.status.log`.

#### Registering Interrupts (CLI)

Use `register-interrupt.js` to manage interrupt rules. Entity IDs are **validated against live Home Assistant entities** before saving — if an entity doesn't exist, the registration is rejected with suggestions for similar entity names. Wildcard patterns (e.g. `light.*`) skip entity existence checks. State values are validated against known domain states (e.g. `binary_sensor` must be `on`/`off`). Use `--skip-validation` to bypass all checks (e.g. when HA is temporarily unavailable).

```bash
# Add a persistent interrupt (entity validated against live HA)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent binary_sensor.front_door_motion --state on --label "Front door motion"

# Add a one-off interrupt (auto-removed after firing)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js one-off person.jesten --state home --label "Jesten arrived"

# Add an interrupt with custom instructions for the agent
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent binary_sensor.front_door_motion --state on --label "Front door" --instruction "Check if anyone is expected; if not, announce security alert via follow-and-speak"

# Specify a notification channel explicitly
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent binary_sensor.front_door_motion --state on --label "Front door" --channel telegram

# Register a direct-message interrupt (bypasses sub-agent evaluation)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent binary_sensor.front_door_motion --state on --label "Front door" --type message --message "Motion at front door!"

# Wildcard: any light turning on (skips entity existence check, validates state)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent "light.*" --state on --label "Light activated"

# Skip validation (e.g. HA is down or entity will be added later)
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js persistent sensor.future_entity --skip-validation

# List all registered interrupts
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js list

# Remove an interrupt by ID
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js remove int-abc123

# View pipeline settings
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js get-settings

# Update message pipeline rate limit
node /home/jherrild/.openclaw/workspace/skills/home-presence/register-interrupt.js set-settings '{"message":{"rate_limit_max":20}}'
```

**Validation behavior:**
- **Entity existence:** Checked via `GET /api/states` against live HA. If not found, returns 3–5 similar entity name suggestions.
- **State plausibility:** Checked against known domain states (e.g. `binary_sensor`: `on`/`off`, `person`: `home`/`not_home`). Domains without a known state list (e.g. `sensor`) skip this check.
- **Channel:** Validated against `openclaw channels list --json` (the keys under `.chat`). The special value `"default"` is always valid and resolves to `config.json`'s `default_channel` at dispatch time.
- **Wildcards:** Patterns containing `*` skip entity existence checks but still validate state if provided.
- **Bypass:** Pass `--skip-validation` to skip all checks.

### Notification Channel Configuration

Interrupts are dispatched to a **notification channel** (e.g., `telegram`). Each interrupt rule can specify a `channel`; if omitted or set to `"default"`, it resolves to the `default_channel` in `config.json` at dispatch time.

**Config file:** `skills/home-presence/config.json`
```json
{
  "default_channel": "telegram"
}
```

**Managing the default channel:**
```bash
# View current default channel
node /home/jherrild/.openclaw/workspace/skills/home-presence/manage-channel.js get

# Update default channel (validates against openclaw)
node /home/jherrild/.openclaw/workspace/skills/home-presence/manage-channel.js set telegram

# Update without validation
node /home/jherrild/.openclaw/workspace/skills/home-presence/manage-channel.js set whatsapp --skip-validation

# List valid channels from openclaw
node /home/jherrild/.openclaw/workspace/skills/home-presence/manage-channel.js list-valid
```

**Channel routing at dispatch time:**
1. Each matched interrupt rule's `channel` field is read.
2. If `channel` is `"default"` (or absent), it is resolved to `config.json`'s `default_channel`.
3. Triggers are grouped by resolved channel and dispatched as separate `openclaw system event` calls, each instructing the agent to notify on the appropriate channel.

### What It Does

- Connects to `ws://homeassistant:8123/api/websocket` (override with `HA_WS_URL` env var).
- Authenticates using the LLAT from `config/mcporter.json` (override with `HA_TOKEN` env var).
- Subscribes to `state_changed` events and classifies each by domain/pattern into one of five log tiers.
- Appends every state change to the appropriate JSONL log file as a single JSON object per line.
- If an entity is in `WAKE_ON_ENTITIES`, also pushes a `home-presence: ...` system event to Magnus.
- Auto-trims each log to 4,000 lines when it exceeds 5,000 lines.
- Reconnects automatically with exponential backoff (1s → 60s max) if the socket drops.
- Sends periodic pings (30s) and terminates/reconnects on pong timeout (10s).
- Singleton guard via `pgrep` (filters out vscode processes to avoid false positives).

### Log Entry Format (all JSONL files)

Each line is a JSON object:

```json
{"ts":"2026-02-08T21:00:00.000Z","entity_id":"binary_sensor.everything_presence_lite_4f1008_occupancy","domain":"binary_sensor","area":"Office","old_state":"off","new_state":"on","summary":"home-presence: Office is now occupied"}
```

| Field | Description |
|-------|-------------|
| `ts` | ISO 8601 timestamp |
| `entity_id` | Home Assistant entity ID |
| `domain` | Entity domain (e.g., `light`, `climate`, `automation`) |
| `area` | Human-readable area name, friendly_name fallback, or `null` |
| `old_state` | Previous state value |
| `new_state` | New state value |
| `summary` | Human-readable event description |

### Checking the Logs

```bash
# View the last 20 presence events
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/presence-log.jsonl

# View recent lighting changes
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/lighting-log.jsonl

# View recent climate/HVAC events
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/climate-log.jsonl

# View recent automation triggers
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/automation-log.jsonl

# View catch-all raw events
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/home-status-raw.jsonl

# Check log sizes
wc -l /home/jherrild/.openclaw/workspace/skills/home-presence/*-log.jsonl /home/jherrild/.openclaw/workspace/skills/home-presence/home-status-raw.jsonl
```

### Starting the Bridge (systemd — preferred)

The bridge runs as a systemd user service (`ha-bridge.service`), which auto-restarts on failure and starts on login.

```bash
# Start / restart
systemctl --user start ha-bridge.service

# Enable auto-start on login (already enabled)
systemctl --user enable ha-bridge.service
```

> **Logs:** Status and connection logs go to `ha-bridge.status.log` in the skill directory. Presence events go to `presence-log.jsonl`; other domain events go to their respective tier logs.

### Checking Status

```bash
# Quick health check
systemctl --user is-active ha-bridge.service

# Detailed status
systemctl --user status ha-bridge.service

# View recent logs
tail -50 /home/jherrild/.openclaw/workspace/skills/home-presence/ha-bridge.status.log
```

### Stopping the Bridge

```bash
systemctl --user stop ha-bridge.service
```

### Debug Entity Dump

To see **all** incoming entity IDs (including those filtered as no-change), send `SIGUSR1` to the running bridge process. This dumps every entity ID to `debug-entities.log` for 30 seconds, then stops automatically.

```bash
# Trigger a 30-second debug dump
kill -USR1 $(pgrep -f 'node.*ha-bridge\.js')

# Watch the output
tail -f /home/jherrild/.openclaw/workspace/skills/home-presence/debug-entities.log
```

### Known Light Entities (Office)

The office lights use these entity IDs in Home Assistant:

| Entity | Description |
|--------|-------------|
| `light.office` | Group entity (all office lights) |
| `light.office_one` | Individual bulb 1 |
| `light.office_two` | Individual bulb 2 |
| `light.office_three` | Individual bulb 3 |

> **Note:** There is no `light.office_lights` entity. Use `light.office` for the group.

### Event Format (in presence-log.jsonl)

Events follow this format in the `summary` field:
- Person: `home-presence: Jesten is now away (was home)`
- Occupancy: `home-presence: Office is now occupied`
- Motion: `home-presence: Front Yard — motion detected`

## Technical Notes

- The `ha-stdio-final` MCP provides `GetLiveContext` for reading sensor state but has **no generic `call_service` tool**, so TTS is triggered via the Home Assistant REST API (`POST /api/services/tts/speak`).
- Person entities (`person.jesten`, `person.april_jane`) are checked first. If both are away and no mmWave/CO₂/motion presence is detected, the house is considered empty and `follow-and-speak` skips TTS.
- CO₂ levels above 600 ppm are used as a secondary occupancy indicator (works well for enclosed rooms like Office, Kitchen, Gym).
- The script deduplicates speakers when multiple occupied areas map to the same physical speaker (e.g., Kitchen and Dining both route to Living Room speaker).
- **Layout durability:** Hardcoded defaults are kept as fallback. Run `update-layout` to query HA's area/device registry via the template API and write `layout.json`. The script loads `layout.json` at startup if present.
