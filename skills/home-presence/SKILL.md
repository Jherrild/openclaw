---
name: home-presence
description: Give Magnus a physical presence in the home — detect occupied rooms, check person home/away status, and speak through local smart speakers using Google AI TTS with the Alnilam voice.
---

# Home Presence

Detect who is home, which rooms are occupied, and route speech to those rooms via Home Assistant TTS.

## Configuration

- **Script Path:** `/home/jherrild/.openclaw/workspace/skills/home-presence/presence.js`
- **HA Token:** Extracted automatically from `config/mcporter.json` (`ha-stdio-final` entry).
- **TTS Engine:** `tts.google_ai_tts` (Google AI TTS)
- **Voice:** `alnilam` (Alnilam — Firm)
- **Default Fallback Area:** Living Room
- **Layout File:** `layout.json` (auto-generated by `update-layout`, optional)

### Person Entities

| Entity | Description |
|--------|-------------|
| `person.jesten` | Primary resident |
| `person.april_jane` | Secondary resident |

### Known Areas → Speakers

| Area | Speaker Entity |
|------|---------------|
| Living Room | `media_player.living_room_speaker` |
| Basement | `media_player.basement` |
| Gym | `media_player.gym` |
| Office | `media_player.pink_window` |
| Bedroom | `media_player.upstairs_bedroom` |
| Kitchen | `media_player.living_room_speaker` (fallback) |
| Dining | `media_player.living_room_speaker` (fallback) |
| Home Group | `media_player.home_group` (all speakers) |

> These are hardcoded defaults. Run `update-layout` to auto-discover mappings from Home Assistant's area/device registry.

### Presence Sensors

| Area | Sensor | Type |
|------|--------|------|
| Kitchen | `binary_sensor.everything_presence_lite_5c0db4_occupancy` | mmWave Occupancy |
| Office | `binary_sensor.everything_presence_lite_4f1008_occupancy` | mmWave Occupancy |
| Gym | `binary_sensor.everything_presence_lite_5c0d08_occupancy` | mmWave Occupancy |
| Bedroom | `binary_sensor.everything_presence_lite_5c0da4_occupancy` | mmWave Occupancy |
| Basement | `binary_sensor.everything_presence_lite_ab20a4_occupancy` | mmWave Occupancy |
| Front Yard | `binary_sensor.front_door_motion` | PIR Motion |
| Kitchen | `sensor.everything_presence_lite_5c0db4_co2` | CO₂ fallback (>600 ppm) |
| Office | `sensor.everything_presence_lite_4f1008_co2` | CO₂ fallback (>600 ppm) |
| Gym | `sensor.everything_presence_lite_5c0d08_co2` | CO₂ fallback (>600 ppm) |

## Tools

### locate_presence

Detect which areas are currently occupied and whether anyone is home.

**Occupancy Logic (in order):**
1. Check `person.jesten` and `person.april_jane` for home/away status.
2. Check mmWave occupancy sensors.
3. Check PIR motion sensors.
4. Check CO₂ levels (>600 ppm).
5. If ALL persons are away AND no sensor presence → `houseEmpty: true`.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js locate
```

**Output:** JSON with `houseEmpty`, `personsHome`, `occupied` (list of area names), `details` (sensor data), `fallback` (set to "Living Room" if persons are home but no room detected; `null` if house is empty), and `layoutSource`.

### announce_to_room

Speak a message through the speaker(s) in a specific area.

**Parameters:**
- `area`: Area name (e.g., "Living Room", "Office", "Gym").
- `message`: The text to speak.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js announce "Office" "Your coffee is ready."
```

### follow_and_speak

Detect who is home and speak in all occupied rooms. If the house is empty (all persons away + no sensor presence), skips TTS entirely.

**Priority Routing:** When the `--priority` flag is passed, the message is treated as important/high-priority and is routed to the **Home Group** (`media_player.home_group`), which targets all speakers simultaneously — bypassing per-room presence detection.

**Routing Rules:**
1. `--priority` flag → Home Group (all speakers)
2. House empty (all away + no sensors) → Skip TTS, return note
3. Presence detected → occupied room speakers only
4. No room-level presence but someone is home → Living Room speaker (default fallback)

**Parameters:**
- `message`: The text to speak.
- `--priority` *(optional)*: Route to all speakers via Home Group.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak "Good morning."
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak --priority "Emergency: water leak detected!"
```

**Output:** JSON showing which areas were occupied, which speakers were targeted, and the result of each TTS call.

### update_layout

Query Home Assistant's area and device registries to auto-discover area→speaker, area→sensor mappings. Writes `layout.json` next to `presence.js`. Run this when new hardware is added.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js update-layout
```

**Output:** JSON with discovered areas, speakers, occupancy sensors, motion sensors, and CO₂ sensors. Also writes `layout.json` for subsequent runs.

## HA WebSocket Bridge (`ha-bridge.js`)

A persistent WebSocket connection to Home Assistant that subscribes to `state_changed` events for all presence-related entities and writes them to a **rolling JSONL log** (`presence-log.jsonl`).

### Architecture: Passive Logging

The bridge operates in **passive log-only mode** by default. Instead of interrupting Magnus with `openclaw system event` on every state change, events are appended to `presence-log.jsonl` — a rolling append-only log capped at 5,000 lines. Magnus (or any tool) can read this log on demand without being woken for each event.

**High-priority wake support** is plumbed in via the `WAKE_ON_ENTITIES` set in `ha-bridge.js`. This set is currently **empty**. To re-enable agent-waking for specific entities, add their IDs to the set:

```js
const WAKE_ON_ENTITIES = new Set([
  'person.jesten',                      // wake when Jesten arrives/leaves
  'binary_sensor.front_door_motion',    // wake on front door motion
]);
```

Only entities in `WAKE_ON_ENTITIES` will trigger `openclaw system event`; all others are logged silently.

### What It Does

- Connects to `ws://homeassistant:8123/api/websocket` (override with `HA_WS_URL` env var).
- Authenticates using the LLAT from `config/mcporter.json` (override with `HA_TOKEN` env var).
- Subscribes to `state_changed` events and filters to watched entities (person entities, mmWave occupancy, motion sensors).
- Appends every state change to `presence-log.jsonl` as a single JSON object per line.
- If an entity is in `WAKE_ON_ENTITIES`, also pushes a `home-presence: ...` system event to Magnus.
- Auto-trims the log to 4,000 lines when it exceeds 5,000 lines.
- Reconnects automatically with exponential backoff (1s → 60s max) if the socket drops.
- Sends periodic pings (30s) and terminates/reconnects on pong timeout (10s).
- Singleton guard via `pgrep` (filters out vscode processes to avoid false positives).

### Presence Log Format (`presence-log.jsonl`)

Each line is a JSON object:

```json
{"ts":"2026-02-08T21:00:00.000Z","entity_id":"binary_sensor.everything_presence_lite_4f1008_occupancy","area":"Office","old_state":"off","new_state":"on","summary":"home-presence: Office is now occupied"}
```

| Field | Description |
|-------|-------------|
| `ts` | ISO 8601 timestamp |
| `entity_id` | Home Assistant entity ID |
| `area` | Human-readable area name (or `null`) |
| `old_state` | Previous state value |
| `new_state` | New state value |
| `summary` | Human-readable event description |

### Checking the Presence Log

```bash
# View the last 20 events
tail -20 /home/jherrild/.openclaw/workspace/skills/home-presence/presence-log.jsonl

# Find all "occupied" events for the Office
grep '"Office"' /home/jherrild/.openclaw/workspace/skills/home-presence/presence-log.jsonl | grep '"occupied"' | tail -10

# Count events per area today
grep "$(date -u +%Y-%m-%d)" /home/jherrild/.openclaw/workspace/skills/home-presence/presence-log.jsonl | \
  python3 -c "import sys,json,collections; c=collections.Counter(json.loads(l).get('area','?') for l in sys.stdin); print(dict(c))"

# Check log size
wc -l /home/jherrild/.openclaw/workspace/skills/home-presence/presence-log.jsonl
```

### Watched Entities

All person entities (`person.jesten`, `person.april_jane`) and all occupancy/motion sensors listed in the Presence Sensors table above.

### Starting the Bridge

```bash
# Start in background (detached)
nohup node /home/jherrild/.openclaw/workspace/skills/home-presence/ha-bridge.js >> /tmp/ha-bridge.log 2>&1 &

# Or with env overrides
HA_WS_URL=ws://192.168.1.50:8123/api/websocket HA_TOKEN=your_token node ha-bridge.js
```

> **Note:** Presence events are written to `presence-log.jsonl` in the skill directory. Console/stderr output (connection status, errors) still goes to `/tmp/ha-bridge.log`.

### Checking Status

```bash
# Check if running (excludes vscode false positives)
pgrep -f 'node.*ha-bridge\.js' | while read pid; do
  cmdline=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ')
  echo "$cmdline" | grep -qv vscode && echo "Running: PID $pid"
done

# View recent logs
tail -50 /tmp/ha-bridge.log
```

### Stopping the Bridge

```bash
# Find the PID (filtering out vscode)
pgrep -f 'node.*ha-bridge\.js' | while read pid; do
  cmdline=$(cat /proc/$pid/cmdline 2>/dev/null | tr '\0' ' ')
  echo "$cmdline" | grep -qv vscode && kill "$pid" && echo "Stopped PID $pid"
done
```

### Event Format (in presence-log.jsonl)

Events follow this format in the `summary` field:
- Person: `home-presence: Jesten is now away (was home)`
- Occupancy: `home-presence: Office is now occupied`
- Motion: `home-presence: Front Yard — motion detected`

## Technical Notes

- The `ha-stdio-final` MCP provides `GetLiveContext` for reading sensor state but has **no generic `call_service` tool**, so TTS is triggered via the Home Assistant REST API (`POST /api/services/tts/speak`).
- Person entities (`person.jesten`, `person.april_jane`) are checked first. If both are away and no mmWave/CO₂/motion presence is detected, the house is considered empty and `follow-and-speak` skips TTS.
- CO₂ levels above 600 ppm are used as a secondary occupancy indicator (works well for enclosed rooms like Office, Kitchen, Gym).
- The script deduplicates speakers when multiple occupied areas map to the same physical speaker (e.g., Kitchen and Dining both route to Living Room speaker).
- **Layout durability:** Hardcoded defaults are kept as fallback. Run `update-layout` to query HA's area/device registry via the template API and write `layout.json`. The script loads `layout.json` at startup if present.
