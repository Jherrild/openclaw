---
name: home-presence
description: Give Magnus a physical presence in the home — detect occupied rooms, check person home/away status, and speak through local smart speakers using Google AI TTS with the Alnilam voice.
---

# Home Presence

Detect who is home, which rooms are occupied, and route speech to those rooms via Home Assistant TTS.

## Configuration

- **Script Path:** `/home/jherrild/.openclaw/workspace/skills/home-presence/presence.js`
- **HA Token:** Extracted automatically from `config/mcporter.json` (`ha-stdio-final` entry).
- **TTS Engine:** `tts.google_ai_tts` (Google AI TTS)
- **Voice:** `alnilam` (Alnilam — Firm)
- **Default Fallback Area:** Living Room
- **Layout File:** `layout.json` (auto-generated by `update-layout`, optional)

### Person Entities

| Entity | Description |
|--------|-------------|
| `person.jesten` | Primary resident |
| `person.april_jane` | Secondary resident |

### Known Areas → Speakers

| Area | Speaker Entity |
|------|---------------|
| Living Room | `media_player.living_room_speaker` |
| Basement | `media_player.basement` |
| Gym | `media_player.gym` |
| Office | `media_player.pink_window` |
| Bedroom | `media_player.upstairs_bedroom` |
| Kitchen | `media_player.living_room_speaker` (fallback) |
| Dining | `media_player.living_room_speaker` (fallback) |
| Home Group | `media_player.home_group` (all speakers) |

> These are hardcoded defaults. Run `update-layout` to auto-discover mappings from Home Assistant's area/device registry.

### Presence Sensors

| Area | Sensor | Type |
|------|--------|------|
| Kitchen | `binary_sensor.everything_presence_lite_5c0db4_occupancy` | mmWave Occupancy |
| Office | `binary_sensor.everything_presence_lite_4f1008_occupancy` | mmWave Occupancy |
| Gym | `binary_sensor.everything_presence_lite_5c0d08_occupancy` | mmWave Occupancy |
| Bedroom | `binary_sensor.everything_presence_lite_5c0da4_occupancy` | mmWave Occupancy |
| Basement | `binary_sensor.everything_presence_lite_ab20a4_occupancy` | mmWave Occupancy |
| Front Yard | `binary_sensor.front_door_motion` | PIR Motion |
| Kitchen | `sensor.everything_presence_lite_5c0db4_co2` | CO₂ fallback (>600 ppm) |
| Office | `sensor.everything_presence_lite_4f1008_co2` | CO₂ fallback (>600 ppm) |
| Gym | `sensor.everything_presence_lite_5c0d08_co2` | CO₂ fallback (>600 ppm) |

## Tools

### locate_presence

Detect which areas are currently occupied and whether anyone is home.

**Occupancy Logic (in order):**
1. Check `person.jesten` and `person.april_jane` for home/away status.
2. Check mmWave occupancy sensors.
3. Check PIR motion sensors.
4. Check CO₂ levels (>600 ppm).
5. If ALL persons are away AND no sensor presence → `houseEmpty: true`.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js locate
```

**Output:** JSON with `houseEmpty`, `personsHome`, `occupied` (list of area names), `details` (sensor data), `fallback` (set to "Living Room" if persons are home but no room detected; `null` if house is empty), and `layoutSource`.

### announce_to_room

Speak a message through the speaker(s) in a specific area.

**Parameters:**
- `area`: Area name (e.g., "Living Room", "Office", "Gym").
- `message`: The text to speak.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js announce "Office" "Your coffee is ready."
```

### follow_and_speak

Detect who is home and speak in all occupied rooms. If the house is empty (all persons away + no sensor presence), skips TTS entirely.

**Priority Routing:** When the `--priority` flag is passed, the message is treated as important/high-priority and is routed to the **Home Group** (`media_player.home_group`), which targets all speakers simultaneously — bypassing per-room presence detection.

**Routing Rules:**
1. `--priority` flag → Home Group (all speakers)
2. House empty (all away + no sensors) → Skip TTS, return note
3. Presence detected → occupied room speakers only
4. No room-level presence but someone is home → Living Room speaker (default fallback)

**Parameters:**
- `message`: The text to speak.
- `--priority` *(optional)*: Route to all speakers via Home Group.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak "Good morning."
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js follow-and-speak --priority "Emergency: water leak detected!"
```

**Output:** JSON showing which areas were occupied, which speakers were targeted, and the result of each TTS call.

### update_layout

Query Home Assistant's area and device registries to auto-discover area→speaker, area→sensor mappings. Writes `layout.json` next to `presence.js`. Run this when new hardware is added.

**Usage:**
```bash
node /home/jherrild/.openclaw/workspace/skills/home-presence/presence.js update-layout
```

**Output:** JSON with discovered areas, speakers, occupancy sensors, motion sensors, and CO₂ sensors. Also writes `layout.json` for subsequent runs.

## Technical Notes

- The `ha-stdio-final` MCP provides `GetLiveContext` for reading sensor state but has **no generic `call_service` tool**, so TTS is triggered via the Home Assistant REST API (`POST /api/services/tts/speak`).
- Person entities (`person.jesten`, `person.april_jane`) are checked first. If both are away and no mmWave/CO₂/motion presence is detected, the house is considered empty and `follow-and-speak` skips TTS.
- CO₂ levels above 600 ppm are used as a secondary occupancy indicator (works well for enclosed rooms like Office, Kitchen, Gym).
- The script deduplicates speakers when multiple occupied areas map to the same physical speaker (e.g., Kitchen and Dining both route to Living Room speaker).
- **Layout durability:** Hardcoded defaults are kept as fallback. Run `update-layout` to query HA's area/device registry via the template API and write `layout.json`. The script loads `layout.json` at startup if present.
